---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: omada-controller
  namespace: flux-system
spec:
  chart:
    spec:
      chart: app-template
      interval: 5m0s
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 3.2.1
  install:
    createNamespace: true
  interval: 30m0s
  targetNamespace: omada
  values:
    controllers:
      omada:
        containers:
          app:
            image:
              repository: docker.io/mbentley/omada-controller
              tag: "5.15"
            env:
              PUID: 508
              PGID: 508
              MANAGE_HTTP_PORT: 8088
              PORTAL_HTTP_PORT: 8089
              PORT_APP_DISCOVERY: 27001
              PORT_ADOPT_V1: 29812
              PORT_UPGRADE_V1: 29813
              PORT_MANAGER_V1: 29811
              PORT_MANAGER_V2: 29814
              PORT_DISCOVERY: 29810
              SHOW_SERVER_LOGS: true
              SHOW_MONGODB_LOGS: false
              TZ: America/New_York

    service:
      app:
        controller: omada
        ports:
          manage-http:
            port: 8088
          portal-http:
            port: 8089
          manage-https:
            port: 8043
          portal-https:
            port: 8843
      service:
        controller: omada
        type: LoadBalancer
        ports:
          app-discovery:
            port: 27001
          adopt-v1:
            port: 29812
          upgrade-v1:
            port: 29813
          manager-v1:
            port: 29811
          manager-v2:
            port: 29814
          discovery:
            port: 29810

    ingress:
      app:
        className: nginx
        hosts:
          - host: omada.cjf.sh
            paths:
              - path: /
                service:
                  identifier: app
                  port: manage-http
        tls:
          - hosts:
              - omada.cjf.sh

      tailscale:
        <<: *ingress
        className: tailscale

    persistence:
      data:
        type: persistentVolumeClaim
        storageClass: zfs-dataset
        globalMounts:
          - path: /opt/tplink/EAPController/data
            readOnly: false
      logs:
        type: emptyDir
        globalMounts:
          - path: /opt/tplink/EAPController/logs
            readOnly: false
